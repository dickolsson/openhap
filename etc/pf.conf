# ex:ts=8 sw=4:
# $OpenBSD$
#
# PF firewall configuration for OpenHAP server on vlan30
#
# Network: 172.16.30.0/24
# Gateway: 172.16.30.1
# Services: HomeKit (51827), MQTT (1883, 8883), SSH (22)

#
# Macros
#

# Network interface (adjust to match your server)
ext_if = "vio0"

# Local network
localnet = "172.16.30.0/24"

# Gateway
gateway = "172.16.30.1"

# HomeKit clients (iOS devices on the LAN)
# Adjust to match your network topology if clients are on different VLANs
table <homekit> persist { $localnet }

# MQTT broker (adjust if your MQTT broker is elsewhere)
mqtt_broker = "$gateway"

#
# Options
#

set skip on lo
set block-policy drop
set loginterface $ext_if

# State table limits appropriate for a HomeKit server
set limit states 10000
set limit src-nodes 1000

# Scrub incoming packets
match in all scrub (no-df random-id max-mss 1440)

#
# Default deny
#

block log all

#
# Allow loopback
#

pass quick on lo

#
# Antispoof
#

antispoof quick for { lo $ext_if }

#
# Outbound
#

# Allow server to establish outbound connections
pass out on $ext_if inet proto tcp from ($ext_if) \
    to any keep state

pass out on $ext_if inet proto udp from ($ext_if) \
    to any keep state

pass out on $ext_if inet proto icmp from ($ext_if) \
    icmp-type { echoreq } keep state

#
# Inbound
#

# ICMP: echo request from local network only
pass in on $ext_if inet proto icmp from $localnet \
    icmp-type { echoreq } keep state

# SSH: Allow from local network for administration
pass in on $ext_if inet proto tcp from $localnet \
    to ($ext_if) port 22 keep state

# HomeKit Accessory Protocol: Port 51827 from authorized clients
# HAP uses HTTP initially, then switches to encrypted sessions
pass in on $ext_if inet proto tcp from <homekit> \
    to ($ext_if) port 51827 keep state \
    (max-src-conn 50, max-src-conn-rate 10/5, overload <homekit> flush global)

# mDNS (Bonjour): Required for HomeKit device discovery
pass in on $ext_if inet proto udp from $localnet \
    to 224.0.0.251 port 5353 keep state

pass out on $ext_if inet proto udp from ($ext_if) \
    to 224.0.0.251 port 5353 keep state

# MQTT: Allow connections to broker for Tasmota device integration
# Uncomment if MQTT broker is on a different host
# pass out on $ext_if inet proto tcp from ($ext_if) \
#     to $mqtt_broker port { 1883 8883 } keep state

