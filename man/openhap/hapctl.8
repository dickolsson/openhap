.\" $OpenBSD$
.\"
.\" Copyright (c) 2025 Dick Olsson <dick@aglim.se>
.\"
.\" Permission to use, copy, modify, and distribute this software for any
.\" purpose with or without fee is hereby granted, provided that the above
.\" copyright notice and this permission notice appear in all copies.
.\"
.\" THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
.\" WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
.\" MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
.\" ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
.\" WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
.\" ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
.\" OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
.\"
.Dd $Mdocdate: December 26 2025 $
.Dt HAPCTL 8
.Os
.Sh NAME
.Nm hapctl
.Nd control utility for openhapd
.Sh SYNOPSIS
.Nm hapctl
.Op Fl c Ar file
.Ar command
.Sh DESCRIPTION
.Nm
is a command-line utility for managing and querying the
.Xr openhapd 8
daemon.
It provides commands for configuration validation,
daemon status checks,
and device management.
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl c Ar file
Specify the configuration file.
The default is
.Pa /etc/openhapd.conf .
.El
.Pp
The following commands are available:
.Bl -tag -width "devicesXX"
.It Cm check
Validate the configuration file syntax.
Parses
.Xr openhapd.conf 5
and reports any syntax errors or invalid values.
Exits with status 0 if the configuration is valid,
non-zero otherwise.
Also displays the number of configured devices.
.It Cm status
Display the status of the
.Xr openhapd 8
daemon and pairing information.
Shows whether the daemon is running,
its process ID,
and the current pairing state (paired, unpaired, or unknown).
For paired accessories,
displays the number of paired HomeKit controllers.
.It Cm devices
List all devices configured in
.Xr openhapd.conf 5 .
For each device, displays:
.Bl -bullet -compact
.It
Device name as it appears in HomeKit
.It
Device type and subtype
.It
MQTT topic prefix
.It
Internal device identifier
.El
.It Cm help
Display usage information.
.El
.Sh EXIT STATUS
.Ex -std
Commands exit with status 0 on success.
.Pp
The
.Cm check
command exits with non-zero status if configuration errors are found.
.Pp
The
.Cm status
and
.Cm devices
commands exit with status 0 regardless of daemon state.
.Sh FILES
.Bl -tag -width "/var/db/openhapd/pairingsXX" -compact
.It Pa /etc/openhapd.conf
Default configuration file.
.It Pa /var/run/openhapd.pid
Process ID of the running daemon.
.It Pa /var/db/openhapd/pairings
Pairing database used for status checks.
.El
.Sh EXAMPLES
Validate the configuration file:
.Bd -literal -offset indent
$ hapctl check
Configuration file /etc/openhapd.conf is valid
  Configured devices: 3
.Ed
.Pp
Check daemon status:
.Bd -literal -offset indent
$ hapctl status
openhapd is running (PID 12345)
Pairing status: paired (2 controllers)
.Ed
.Pp
List configured devices:
.Bd -literal -offset indent
$ hapctl devices
Configured devices: 2

  Bedroom Thermostat
    Type:  tasmota/thermostat
    Topic: tasmota_AABBCC
    ID:    bedroom

  Living Room Thermostat
    Type:  tasmota/thermostat
    Topic: tasmota_DDEEFF
    ID:    living_room
.Ed
.Pp
Use an alternate configuration file:
.Bd -literal -offset indent
$ hapctl -c /etc/openhapd.test.conf check
.Ed
.Sh DIAGNOSTICS
Configuration errors are reported to
.Em stderr
with descriptive messages.
.Pp
If
.Xr openhapd 8
is not running,
.Cm status
will report:
.Bd -literal -offset indent
openhapd is not running
.Ed
.Pp
If the pairing database cannot be read,
.Cm status
will report:
.Bd -literal -offset indent
Pairing status: unknown (cannot read storage)
.Ed
.Sh SEE ALSO
.Xr openhapd 8 ,
.Xr openhapd.conf 5 ,
.Xr rc 8
.Sh HISTORY
The
.Nm
utility first appeared with
.Xr openhapd 8
in 2025.
.Sh AUTHORS
.An Dick Olsson Aq Mt dick@aglim.se
.Sh CAVEATS
.Nm
reads the pairing database directly to determine pairing status.
This requires read access to
.Pa /var/db/openhapd/ .
When run as a non-root user,
pairing status may be reported as
.Dq unknown .
