=head1 NAME

OpenHAP::MDNS - mDNS service registration wrapper for mdnsctl(8)

=head1 SYNOPSIS

    use OpenHAP::MDNS;

    my $mdns = OpenHAP::MDNS->new(
        service_name => 'OpenHAP Bridge',
        port         => 51827,
        txt_records  => {
            'c#' => 1,
            'ff' => 0,
            'id' => 'AA:BB:CC:DD:EE:FF',
            'md' => 'OpenHAP',
            'pv' => '1',
            's#' => 1,
            'sf' => 1,
            'ci' => 2,
        },
    );

    $mdns->register_service();

    # Later, on shutdown
    $mdns->unregister_service();

=head1 DESCRIPTION

This module provides a wrapper around OpenBSD's C<mdnsctl(8)> command
to register HomeKit Accessory Protocol (HAP) services with C<mdnsd(8)>
for Bonjour/mDNS service discovery.

iOS devices use mDNS to discover HAP accessories on the local network.
This module enables that discovery by registering the appropriate service
with the required TXT records.

=head1 METHODS

=head2 new

    my $mdns = OpenHAP::MDNS->new(%args);

Create a new MDNS registration handler. Options:

=over 4

=item C<service_name> (string)

The service name to advertise. This appears as the accessory name in the
Home app. Default: C<OpenHAP Bridge>.

=item C<port> (integer)

TCP port number where the HAP server is listening. Default: C<51827>.

=item C<txt_records> (hashref)

TXT record key-value pairs for the service. Required HAP fields:

=over 4

=item C<c#> - Configuration number (incremented when accessories change)

=item C<ff> - Feature flags (typically 0)

=item C<id> - Device ID in XX:XX:XX:XX:XX:XX format

=item C<md> - Model name

=item C<pv> - Protocol version (1, not 1.1 due to mdnsd dot delimiter)

=item C<s#> - State number (typically 1)

=item C<sf> - Status flags (1 if unpaired, 0 if paired)

=item C<ci> - Category identifier (2 for bridge)

=back

Default: C<{}>.

=item C<mdnsctl> (string)

Path to the C<mdnsctl> command. Default: C</usr/sbin/mdnsctl>.

=back

=head2 register_service

    $mdns->register_service();

Register the HAP service with mdnsd via mdnsctl. Forks a background
process that executes:

    mdnsctl publish "Service Name" hap tcp port "key1=val1.key2=val2"

Note that TXT record entries are separated by dots (C<.>), not commas.
This matches how C<mdnsd(8)> serializes TXT records internally using
length-prefixed character-strings per RFC 6763.

The C<mdnsctl> process must remain running to maintain the service
registration. The process ID is stored internally and can be killed
via C<unregister_service()>.

Returns C<1> on success, C<undef> on failure. Failures are logged as
warnings but do not die, allowing the daemon to continue running even
if mdnsd is not available.

If the service is already registered, this method returns immediately
without attempting re-registration.

=head2 unregister_service

    $mdns->unregister_service();

Unregister the HAP service by killing the mdnsctl process. Sends
a TERM signal to the background mdnsctl process started by
C<register_service()>.

Returns C<1> always. This should be called during daemon shutdown
to clean up the service registration.

If the service is not registered, this method returns immediately.

=head2 is_registered

    my $bool = $mdns->is_registered();

Returns true if the service is currently registered with mdnsd.

=head1 ERROR HANDLING

All methods that interact with mdnsctl handle errors gracefully:

=over 4

=item *

Failures are logged as warnings via L<OpenHAP::Log>

=item *

Methods return C<undef> on failure rather than dying

=item *

The daemon can continue operating without mDNS registration

=back

This design allows OpenHAP to function even when C<mdnsd(8)> is not
running or available.

=head1 EXAMPLES

=head2 Basic Usage

    use OpenHAP::MDNS;
    use OpenHAP::HAP;

    my $hap = OpenHAP::HAP->new(name => 'My Bridge');
    
    my $mdns = OpenHAP::MDNS->new(
        service_name => $hap->{name},
        port         => 51827,
        txt_records  => $hap->get_mdns_txt_records(),
    );

    $mdns->register_service();

=head2 Custom mdnsctl Path

    my $mdns = OpenHAP::MDNS->new(
        service_name => 'Test Bridge',
        mdnsctl      => '/usr/local/sbin/mdnsctl',
    );

=head1 OPENBSD CONVENTIONS

This module follows OpenBSD conventions:

=over 4

=item *

Uses C<mdnsctl(8)> rather than implementing mDNS protocol directly

=item *

Fails gracefully when system services are unavailable

=item *

Logs via syslog using L<OpenHAP::Log>

=item *

Returns undef for recoverable errors, reserves die for programming errors

=back

=head1 SEE ALSO

L<OpenHAP::HAP>, L<OpenHAP::Log>, L<mdnsctl(8)>, L<mdnsd(8)>

=cut
