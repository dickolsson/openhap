=head1 NAME

FuguLib::Privdrop - Privilege dropping for OpenBSD daemons

=head1 SYNOPSIS

    use FuguLib::Privdrop;
    
    # Start as root, do privileged operations
    $socket->bind(80);  # Bind privileged port
    $mdns->register();  # Fork mdnsctl as root
    
    # Drop privileges before main event loop
    FuguLib::Privdrop->drop_privileges(user => '_myapp');
    
    # Now running as _myapp
    $server->run();

=head1 DESCRIPTION

FuguLib::Privdrop provides privilege dropping functionality for OpenBSD daemons.
This is a common security pattern where a daemon starts as root to perform
privileged operations (binding low ports, forking privileged child processes),
then permanently drops privileges to an unprivileged user before entering the
main event loop.

This minimizes the attack surface by ensuring the bulk of the daemon's code
runs without elevated privileges.

=head1 METHODS

=head2 drop_privileges(%args)

Permanently drops privileges from root to the specified user and group.

Arguments:

=over 4

=item user => $username (required)

Username to drop privileges to. Must be a valid system user.

=item group => $groupname (optional)

Group to drop privileges to. If not specified, uses the user's primary group.

=back

Dies on error. Returns 1 on success.

The method performs the following steps:

=over 4

=item 1. Verifies running as root (returns immediately if already non-root)

=item 2. Looks up UID and GID for specified user/group

=item 3. Calls setgid() to drop group privileges (must be done before setuid)

=item 4. Calls setuid() to drop user privileges

=item 5. Verifies privileges were actually dropped

=item 6. Verifies we cannot regain root privileges

=back

Example:

    # Drop to _openhap user (uses _openhap's primary group)
    FuguLib::Privdrop->drop_privileges(user => '_openhap');
    
    # Drop to specific user and group
    FuguLib::Privdrop->drop_privileges(
        user  => '_www',
        group => 'www'
    );

=head1 TYPICAL USAGE PATTERN

    #!/usr/bin/env perl
    use v5.36;
    use FuguLib::Privdrop;
    
    # Must start as root
    die "Must run as root" unless $> == 0;
    
    # Do privileged operations
    my $socket = IO::Socket::INET->new(
        LocalPort => 80,
        ReuseAddr => 1,
        Listen    => SOMAXCONN,
    ) or die "Cannot bind port 80: $!";
    
    # Fork privileged child processes
    fork_mdnsctl_as_root();
    
    # Drop privileges before main loop
    FuguLib::Privdrop->drop_privileges(user => '_myapp');
    
    # Main event loop runs as _myapp
    while (my $client = $socket->accept()) {
        handle_client($client);
    }

=head1 SECURITY NOTES

=over 4

=item *

The privilege drop is permanent - the process cannot regain root privileges.

=item *

Group privileges are dropped before user privileges (required for proper setuid).

=item *

Both real and effective UIDs/GIDs are set to ensure complete privilege drop.

=item *

The method verifies the drop succeeded and dies if any step fails.

=back

=head1 SEE ALSO

L<FuguLib::Process>, L<OpenHAP::Daemon>, setuid(2), setgid(2)

=head1 AUTHORS

Dick Olsson <hi@dickolsson.com>

=cut
