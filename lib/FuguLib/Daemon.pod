=head1 NAME

FuguLib::Daemon - Daemonization support for Unix daemons

=head1 SYNOPSIS

    use FuguLib::Daemon;
    use FuguLib::State;
    use FuguLib::Log;
    
    # Initialize logging for daemon
    my $log = FuguLib::Log->new(
        mode  => 'syslog',
        ident => 'mydaemon',
    );
    
    # Daemonize
    FuguLib::Daemon->daemonize(
        logfile => '/var/log/mydaemon.log',
        on_fork => sub($pid) {
            # Parent process - write PID file before exiting
            my $state = FuguLib::State->new(
                pidfile => '/var/run/mydaemon.pid'
            );
            $state->write_pid($pid);
        }
    );
    
    # Now running as daemon
    $log->info('Daemon started, PID: %d', $$);
    
    # Main event loop
    while (1) {
        # ... daemon work ...
    }

=head1 DESCRIPTION

FuguLib::Daemon provides daemonization functionality following Unix daemon
conventions. It handles forking into the background, detaching from the
controlling terminal, and redirecting standard file descriptors.

This module is designed to work with FuguLib::State for PID file management
and FuguLib::Log for logging.

=head1 METHODS

=head2 daemonize(%args)

Forks into the background and detaches from the controlling terminal.
Returns only in the child process. Parent process exits successfully.

Arguments:

=over 4

=item logfile => $path (optional, default: /dev/null)

Path where STDOUT and STDERR should be redirected. Typically /dev/null
for daemons using syslog, or a log file for file-based logging.

=item on_fork => sub($pid) (optional)

Callback executed in the parent process after successful fork, before
the parent exits. Receives the child PID as an argument. Useful for
writing PID files or performing other cleanup in the parent.

=back

Example:

    # Simple daemonization
    FuguLib::Daemon->daemonize();
    
    # With logging to file
    FuguLib::Daemon->daemonize(
        logfile => '/var/log/myapp.log'
    );
    
    # With PID file creation in parent
    FuguLib::Daemon->daemonize(
        on_fork => sub($pid) {
            open my $fh, '>', '/var/run/myapp.pid';
            print $fh "$pid\n";
            close $fh;
        }
    );

=head1 TYPICAL DAEMON PATTERN

    #!/usr/bin/env perl
    use v5.36;
    use FuguLib::Daemon;
    use FuguLib::State;
    use FuguLib::Log;
    use FuguLib::Privdrop;
    
    # Parse command line options
    my $foreground = 0;
    # ... option parsing ...
    
    # Initialize logging
    my $log = FuguLib::Log->new(
        mode  => $foreground ? 'stderr' : 'syslog',
        ident => 'mydaemon',
        level => 'info',
    );
    
    unless ($foreground) {
        # Daemonize
        FuguLib::Daemon->daemonize(
            on_fork => sub($pid) {
                my $state = FuguLib::State->new(
                    pidfile => '/var/run/mydaemon.pid'
                );
                $state->write_pid($pid);
            }
        );
    }
    
    $log->info('Starting mydaemon');
    
    # If started as root, do privileged operations then drop
    if ($> == 0) {
        # ... privileged operations ...
        FuguLib::Privdrop->drop_privileges(user => '_mydaemon');
        $log->info('Dropped privileges to _mydaemon');
    }
    
    # Main event loop
    while (1) {
        # ... daemon work ...
    }

=head1 SECURITY NOTES

=over 4

=item *

Call daemonize() early, before opening files or sockets that should be inherited.

=item *

Use FuguLib::Privdrop to drop privileges after daemonization and privileged operations.

=item *

Use FuguLib::State for PID file management with proper locking.

=item *

Redirect logging to syslog rather than files for security and manageability.

=back

=head1 SEE ALSO

L<FuguLib::State>, L<FuguLib::Log>, L<FuguLib::Privdrop>, L<FuguLib::Process>,
daemon(3), setsid(2)

=head1 AUTHORS

Dick Olsson <hi@dickolsson.com>

=cut
