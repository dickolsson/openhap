#!/usr/bin/env perl
use v5.36;
use Getopt::Long;
use FindBin qw($RealBin);
use lib "$RealBin/../lib";

use OpenHAP::HAP;
use OpenHAP::Config;
use FuguLib::Log;
use OpenHAP::MQTT;
use OpenHAP::MDNS;
use OpenHAP::Daemon;
use OpenHAP::DeviceLoader;
use FuguLib::Signal;

# Default configuration
my $config_file  = '/etc/openhapd.conf';
my $foreground   = 0;
my $check_config = 0;
my $verbose      = 0;

GetOptions(
	'c|config=s'   => \$config_file,
	'f|foreground' => \$foreground,
	'n|check'      => \$check_config,
	'v|verbose+'   => \$verbose,
	'h|help'       => \&usage,
) or usage();

# Load configuration
my $config = OpenHAP::Config->new( file => $config_file );
$config->load() if -f $config_file;

if ($check_config) {
	print "Configuration file $config_file is valid\n";
	exit 0;
}

# Daemonize first, before initializing logging
# This ensures syslog connection is opened in the child process
if ( !$foreground ) {
	OpenHAP::Daemon->daemonize('/var/log/openhapd.log');
}

# Initialize logging after daemonizing
my $log_level    = $config->get( 'log_level',    'info' );
my $log_facility = $config->get( 'log_facility', 'daemon' );
my $log_mode     = $foreground ? 'stderr' : 'syslog';

# Create logger and set as package variable for all OpenHAP modules
$OpenHAP::logger = FuguLib::Log->new(
	mode     => $log_mode,
	ident    => 'openhapd',
	level    => $verbose ? 'debug' : $log_level,
	facility => $log_facility,
);

$OpenHAP::logger->info('OpenHAP daemon initializing');

# Get HAP settings
my $hap_name = $config->get( 'hap_name', 'OpenHAP Bridge' );
my $hap_port = $config->get( 'hap_port', 51827 );
my $hap_pin  = $config->get( 'hap_pin',  '1995-1018' );
my $db_path  = $config->get( 'db_path',  '/var/db/openhapd' );

# Create HAP server
my $hap = OpenHAP::HAP->new(
	port         => $hap_port,
	pin          => $hap_pin,
	name         => $hap_name,
	storage_path => $db_path,
);

# Initialize MQTT client
my $mqtt_host = $config->get( 'mqtt_host', '127.0.0.1' );
my $mqtt_port = $config->get( 'mqtt_port', 1883 );
my $mqtt_user = $config->get('mqtt_user');
my $mqtt_pass = $config->get('mqtt_pass');

my $mqtt = OpenHAP::MQTT->new(
	host     => $mqtt_host,
	port     => $mqtt_port,
	username => $mqtt_user,
	password => $mqtt_pass,
);

# Try to connect to MQTT with timeout
if ( $mqtt->mqtt_connect(5) ) {
	$OpenHAP::logger->info( 'Connected to MQTT broker at %s:%d',
		$mqtt_host, $mqtt_port );
	$hap->set_mqtt_client($mqtt);
}
else {
	$OpenHAP::logger->warning(
		'MQTT broker not available, will retry in background');
	$hap->set_mqtt_client($mqtt);    # Set client anyway for reconnection
}

# Load devices from configuration
my $loader = OpenHAP::DeviceLoader->new();
$loader->load_devices( $config, $hap, $mqtt );

# Create mDNS handler (registration happens after privilege drop)
my $mdns = OpenHAP::MDNS->new(
	service_name => $hap_name,
	port         => $hap_port,
	txt_records  => $hap->get_mdns_txt_records(),
);

# Drop privileges before registering mDNS
# _openhap must be in wheel group to access /var/run/mdnsd.sock
# This ensures mdnsctl runs as _openhap and can be killed on shutdown
if ( $> == 0 ) {

	# Ensure db_path is owned by _openhap before dropping privileges
	# This allows mdnsctl log and other runtime files to be written
	my ( $uid, $gid ) = ( getpwnam('_openhap') )[ 2, 3 ];
	if ( defined $uid && -d $db_path ) {
		chown $uid, $gid, $db_path
		    or $OpenHAP::logger->warning("Cannot chown $db_path: $!");

		# Also chown any existing files in the directory
		opendir( my $dh, $db_path ) or next;
		while ( my $file = readdir($dh) ) {
			next if $file =~ /^\.\.?$/;
			my $path = "$db_path/$file";
			chown $uid, $gid, $path
			    or
			    $OpenHAP::logger->warning("Cannot chown $path: $!");
		}
		closedir($dh);
	}

	use FuguLib::Privdrop;
	FuguLib::Privdrop->drop_privileges( user => '_openhap' );

	# Reinitialize logging after dropping privileges
	# The syslog connection opened as root needs to be reopened as _openhap
	$OpenHAP::logger = undef;
	$OpenHAP::logger = FuguLib::Log->new(
		mode     => $log_mode,
		ident    => 'openhapd',
		level    => $verbose ? 'debug' : $log_level,
		facility => $log_facility,
	);

	$OpenHAP::logger->info('Dropped privileges to _openhap');
}

# Register mDNS service after privilege drop
# mdnsctl will run as _openhap (must be in wheel group)
$mdns->register_service();

if ( !$hap->is_paired() ) {
	$OpenHAP::logger->notice( 'Not paired - use Home app with PIN: %s',
		$hap_pin );
}

# Setup signal handlers for graceful shutdown
my $sig = FuguLib::Signal->new;
$sig->add_cleanup(
	sub ($signal) {
		$OpenHAP::logger->info(
			'Received signal %s, shutting down gracefully',
			$signal );

		# Terminate mdnsctl child process
		$mdns->unregister_service();

		$OpenHAP::logger = undef;    # Close logger
	} );
$sig->setup_graceful_exit( 'INT', 'TERM', 'HUP' );

# Run server
$OpenHAP::logger->info('Starting OpenHAP server');
$hap->run();

sub usage()
{
	print STDERR <<EOF;
Usage: openhapd [options]

Options:
    -c, --config FILE    Configuration file (default: /etc/openhapd.conf)
    -f, --foreground     Run in foreground (log to stderr)
    -n, --check          Check configuration and exit
    -v, --verbose        Increase verbosity (can be repeated)
    -h, --help           Show this help

See openhapd(8) for more information.

EOF
	exit 1;
}
